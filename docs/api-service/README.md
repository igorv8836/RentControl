# RentControl — отдельный API service

Контекст: мобильный клиент **не** ходит в API напрямую. Все запросы клиента идут в **BDUI-server**, а BDUI-server уже обращается к этому **API service** за бизнес‑данными и выполнением операций.

Цель этой директории — держать **план работ**, **полный TODO‑лист** и **план тестирования** для API service в формате чек‑листов, чтобы по мере реализации ставить галочки и контролировать готовность.

## Исходные требования

- `docs/server-api.md` — список требуемых HTTP‑эндпоинтов (пока без конкретных схем запросов/ответов).
- `docs/project-functions.md` — бизнес‑требования и роли.
- `docs/project-stages.md` — этапы продукта (можно использовать как майлстоуны).

## Документы в этой директории

- `docs/api-service/plan.md` — этапы/майлстоуны, критерии готовности.
- `docs/api-service/todo.md` — полный TODO‑лист по реализации API service (чек‑лист задач).
- `docs/api-service/testing.md` — виды тестов + чек‑лист тестирования всего функционала.
- `docs/api-service/module-structure.md` — структура модулей в `server/rent-control-server` и шаблон структуры одного модуля.

## Принятые решения (зафиксировано)

1) **Токены и сессии**: API service выдаёт токены (из `Auth`), BDUI-server **делегирует** проверку access‑токена в API service — на **каждый** запрос BDUI-server сначала запрашивает user context в API service (например `GET /me`), и только после этого рендерит/выполняет дальнейшие вызовы.
   - Refresh‑токен хранится на клиенте и проксируется через BDUI-server в API service (`/auth/refresh`).
   - `GET /me` используем как “validate + user context” (отдельный `introspect` эндпоинт не планируем).
   - В BDUI-server кэшируем результат `GET /me` на короткий TTL (ключ кэша = access‑токен; TTL конфигурируемый, default = 120 секунд и не больше оставшегося времени жизни токена).
2) **Вложения**: делаем абстракцию storage (интерфейс) с заменяемыми реализациями: локальная и внешняя (CDN) — можно переключать без изменения доменной логики.
   - Клиент **не** загружает файлы напрямую в CDN: загрузка идёт через BDUI-server → API service (proxy upload).
3) **Email/OTP**: пока используем mock‑реализацию отправки/доставки OTP, позже заменим на SMTP/провайдера.
4) **Push**: используем FCM.
5) **Sync/offline**: конфликты разрешаем автоматически по стратегии “Last‑Write‑Wins” (выбор “самого нового” состояния), но включаем это **только после согласия пользователя** (флаг/настройка хранится в профиле через `PATCH /me`).
   - Если пользователь не согласен — поведение по умолчанию: **server wins** (локальные конфликтующие изменения тихо отклоняются, BDUI обновляет локальный кэш серверным состоянием).

## Базовые допущения

1) **HTTP контракт API** соответствует `docs/server-api.md` (base path `/api/v1`, JSON).
2) **Аутентификация и авторизация**: Bearer‑токен для всех эндпоинтов, кроме `Auth`.

## Открытые вопросы

1) Инвалидация кэша `GET /me`:
   - достаточно ли “по TTL + по смене access‑токена”, или нужно дополнительно сбрасывать кэш при `401/403` и при logout/logout-all?

## CDN upload: что такое pre-signed URL и зачем он нужен (справка)

Есть два базовых способа загрузки медиа (фото/видео/чеки), оба нормальные — различаются тем, **через кого идёт сам файл**.

### Вариант B — proxy upload (через BDUI/API)

Поток:
1) Клиент отправляет файл в BDUI-server.
2) BDUI-server пересылает файл в API service (`POST /attachments`).
3) API service сохраняет файл (локально или в CDN) и возвращает `attachmentId`.

Плюсы:
- самый простой поток (соответствует текущему описанию `POST /attachments` как “загрузка файла”)
- клиент общается только с BDUI-server (без отдельного домена CDN)

Минусы:
- большой трафик и нагрузка на BDUI/API (особенно видео)
- выше риск таймаутов/ретраев/дубликатов

### Вариант A — direct upload (pre-signed URL)

Поток:
1) Клиент просит “подготовить загрузку” (через BDUI-server → API service): отправляет метаданные файла (размер, тип).
2) API service возвращает **pre‑signed URL** (временная ссылка на загрузку) и `attachmentId`.
3) Клиент загружает файл **напрямую в CDN** по pre‑signed URL (минуя BDUI/API).
4) Клиент сообщает серверу “загрузка завершена” (confirm), после чего `attachmentId` можно привязывать к сущностям.

Плюсы:
- BDUI/API почти не тратят трафик на файлы, лучше масштабируется
- быстрее для пользователя, проще делать резюмируемые загрузки

Минусы:
- клиент ходит на домен CDN (это нормально, но это отдельный network endpoint)
- поток чуть сложнее (prepare/confirm), нужны политики TTL и проверки целостности
