# План работ: RentControl API service

## Цель

Сделать отдельный **API service** (бизнес‑контур), который полностью покрывает контракт из `docs/server-api.md` и устойчиво работает в связке:

`Mobile client → BDUI-server → API service → DB/Storage/Providers`

## Definition of Done (для любого эндпоинта/фичи)

- [ ] Описан контракт (минимум: request/response + ошибки + коды) и обновлён OpenAPI/спеки (если ведём).
- [ ] Реализована бизнес‑логика + проверки прав (RBAC/ABAC).
- [ ] Добавлены unit‑тесты для правил/валидаций/переходов статусов.
- [ ] Добавлены API/integration‑тесты на HTTP слой (позитив/негатив/права).
- [ ] Прописаны события аудита (если применимо) и проверены тестами.
- [ ] Проставлены метрики/логи (без утечек PII/секретов).
- [ ] Для изменений в БД есть миграции (и тест на применение миграций).

## Майлстоуны

Ниже этапы с критериями. Детальные задачи — в `docs/api-service/todo.md`.

### M0 — База проекта (foundation)

**Цель:** создать каркас сервиса, стандарты контрактов и инфраструктуру разработки.

Критерии готовности:
- [ ] Единый формат ошибок (validation/auth/forbidden/notFound/conflict/limitExceeded).
- [ ] Конвенции: пагинация, сортировка, фильтры, даты/таймзоны, idempotency.
- [ ] Конфиг/секреты через env + application.conf, профили dev/test/prod.
- [ ] DB слой: миграции + транзакции + тестовый Postgres (Testcontainers).
- [ ] Observability: структурные логи, correlation id, базовые метрики.
- [ ] Базовые security меры (CORS по нужде, rate limit на auth, password hashing).

### M1 — Auth + сессии

**Скоуп:** `POST /auth/*` из `docs/server-api.md`.

Критерии готовности:
- [ ] Регистрация с OTP (request/confirm), логин, refresh, logout.
- [ ] Reset password (request/confirm).
- [ ] Политика пароля и блокировка аккаунта.
- [ ] Ротация refresh‑токенов, отзыв сессий (минимум для “logout current”).
- [ ] Негативные сценарии: неверный OTP/пароль, лимиты попыток, просроченный код.
- [ ] Поток авторизации через BDUI-server зафиксирован: BDUI-server на каждый запрос получает user context из API service (например `GET /me`) и тем самым валидирует access‑токен.
- [ ] Поток refresh зафиксирован: refresh‑токен хранится у клиента и проксируется через BDUI-server в API service (`/auth/refresh`).
- [ ] В BDUI-server включён кэш `GET /me` на короткий TTL (конфиг, default = 120 секунд, ограничения по exp) и покрыт интеграционными тестами.

### M2 — Профиль и администрирование пользователей

**Скоуп:** `/me`, `/users/*`, `/ref/roles`.

Критерии готовности:
- [ ] `GET /me`, `PATCH /me` (профиль/настройки), `POST /me/sessions/logout-all`.
- [ ] CRUD пользователей (admin), блок/разблок.
- [ ] Ограничение выдачи пользователей по ролям/поиску (для назначения исполнителей/согласующих).

### M3 — Справочники

**Скоуп:** все `GET /ref/*` из `docs/server-api.md`.

Критерии готовности:
- [ ] Роли, статусы, категории, приоритеты, шаблоны чек‑листов + структура шаблона.
- [ ] Стабильные идентификаторы справочников (важно для клиента/BDUI).
- [ ] Кэширование справочников (опционально), версия справочников (опционально).

### M4 — Объекты и арендаторы

**Скоуп:** `/objects/*`, `/tenants/*`, связь “объект–арендатор”, `GET /objects/{objectId}/activity`.

Критерии готовности:
- [ ] Поиск/фильтры/сортировки объектов.
- [ ] Создание/редактирование/архивирование объектов (по ролям).
- [ ] CRUD арендаторов + link/unlink к объекту.
- [ ] Агрегаты для карточки объекта (дефекты/осмотры/расходы/показания).

### M5 — Осмотры

**Скоуп:** `/inspections/*` + работа с чек‑листом.

Критерии готовности:
- [ ] Планирование/редактирование/отмена.
- [ ] Старт/финиш осмотра, итоговый комментарий, опциональная генерация дефектов.
- [ ] Обновление результатов чек‑листа (`PATCH /inspections/{id}/checklist`).
- [ ] Утверждение/отклонение результата.
- [ ] Ролевые права: кто планирует, кто выполняет, кто утверждает.

### M6 — Дефекты

**Скоуп:** `/defects/*` + комментарии.

Критерии готовности:
- [ ] Реестр дефектов с фильтрами (в т.ч. просрочка, “назначенные мне”).
- [ ] Карточка дефекта с историей, смена статусов, комментарии с вложениями.
- [ ] SLA/дедлайны (минимум: вычисление просрочки).

### M7 — Расходы

**Скоуп:** `/expenses/*` + сценарии подтверждения.

Критерии готовности:
- [ ] Правило видимости расходов (только свои + участник подтверждения).
- [ ] Черновик → submit → approve/reject → cancel.
- [ ] История подтверждений + статусы.
- [ ] Агрегаты по объекту (план/факт/отклонение).

### M8 — Приборы учёта и показания

**Скоуп:** `/objects/{objectId}/meters/*`.

Критерии готовности:
- [ ] CRUD приборов (если допускается моделью).
- [ ] История показаний + проверки “меньше предыдущего” и “аномальный скачок”.

### M9 — Вложения и медиа

**Скоуп:** `/attachments/*`.

Критерии готовности:
- [ ] Upload + метаданные + download link.
- [ ] Привязка вложений к осмотрам/дефектам/расходам.
- [ ] Политики доступа и удаления (в т.ч. “нельзя удалить закреплённое в утверждённых сущностях”).
- [ ] Storage абстрагирован интерфейсом, можно переключить локальное хранение ↔ CDN без изменения API/доменной логики.
- [ ] Поддержан proxy upload: клиент → BDUI-server → API service → storage/CDN (без прямого доступа клиента к CDN).

### M10 — Уведомления и push токены

**Скоуп:** `/notifications/*`, `/push/token`.

Критерии готовности:
- [ ] Реестр уведомлений, read/read-all.
- [ ] Регистрация/удаление push‑токена.
- [ ] Генерация уведомлений на ключевые события (назначение осмотра, просрочка дефекта, подтверждение расхода).
- [ ] Push провайдер: FCM (заглушка/мок для тестов, реальная интеграция позже).

### M11 — Синхронизация и офлайн

**Скоуп:** `/sync/batch`, `/sync/since`.

Критерии готовности:
- [ ] Приём батча офлайн‑операций с идемпотентностью по operationId.
- [ ] Ответ с результатами по каждой операции (applied/duplicate/rejected/conflict).
- [ ] Выдача изменений “since” (по времени/версии) для локального кэша.
- [ ] Конфликты: версионирование сущностей + `conflict` ответы + авто‑разрешение по стратегии “Last‑Write‑Wins” после согласия пользователя (настройка в профиле).
- [ ] Если согласия на auto‑LWW нет — поведение по умолчанию “server wins” (конфликтующие локальные изменения не применяются).

### M12 — Аудит и события

**Скоуп:** `/audit/events` + эндпоинты по сущностям.

Критерии готовности:
- [ ] Единая модель audit event (кто/когда/что/контекст).
- [ ] Фильтры по сущности/периоду/автору.
- [ ] Гранулярные события на ключевые операции (минимум по `docs/project-functions.md`).

### M13 — Production hardening

Критерии готовности:
- [ ] Ограничения размера запросов/вложений, лимиты списка/пагинации.
- [ ] Защита от злоупотреблений: rate limits, lockout policies, audit for auth.
- [ ] Докеризация (или другой способ доставки), healthchecks, readiness/liveness.
- [ ] CI: сборка + тесты + статический анализ + публикация артефактов.
- [ ] Runbook: как запускать локально/в staging/prod, как дебажить, как откатывать миграции.
