# Тестирование RentControl API service

Цель: иметь тесты, которые покрывают **весь функционал** API service и гарантируют безопасную интеграцию с BDUI-server.

Документ — чек‑лист видов тестов и обязательных сценариев. По мере реализации ставим галочки.

---

## 1) Пирамида тестов (уровни)

### Unit tests (быстрые, без I/O)

- [ ] Валидация входных DTO (email, пароль, суммы, даты, обязательность).
- [ ] Переходы статусов (осмотр/дефект/расход): разрешённые/запрещённые.
- [ ] RBAC/ABAC правила доступа (роль + “владелец/участник подтверждения/исполнитель”).
- [ ] Бизнес‑инварианты (например: показания не меньше предыдущих, сумма > 0).
- [ ] Идемпотентность: дедупликация по ключу операции (как чистая логика).

### Component/service tests (с фейками)

- [ ] Сервисы домена с in‑memory репозиториями (auth/users/objects/…): happy path + негативные сценарии.
- [ ] Генерация событий аудита/уведомлений (без реального транспорта).

### Repository/DB tests (Postgres)

- [ ] Тесты запросов/индексов/фильтров на Postgres (Testcontainers).
- [ ] Тесты конкурентных обновлений (optimistic locking/версионирование).
- [ ] Тесты миграций (apply на пустую БД + совместимость с уже заполненными данными).

### API/HTTP tests (Ktor test host)

- [ ] Тесты роутинга: статус‑коды, схемы JSON, пагинация, ошибки в едином формате.
- [ ] Тесты авторизации: без токена/с токеном, истёкший токен, заблокированный пользователь.
- [ ] `GET /me` используется как “validate + user context”: тесты 401/403, корректность payload, отсутствие лишних данных, стабильность полей.
- [ ] Тесты лимитов: размер body, ограничения списка, ограничения upload.

### Integration tests (несколько реальных компонентов)

- [ ] API + Postgres + storage (локальный/заглушка CDN) + mock OTP: проверка целых сценариев.
- [ ] Тесты background jobs (уведомления по дедлайнам/очистка OTP/retention).

### Contract tests (BDUI-server ↔ API service)

- [ ] Валидация соответствия OpenAPI (если ведём) — “API соответствует спецификации”.
- [ ] Consumer‑driven contract tests (опционально, Pact): “BDUI-server ожидания совместимы”.
- [ ] Snapshot regression на ключевые ответы (списки/карточки) для раннего обнаружения breaking changes.

### E2E (смоук на связку)

- [ ] Запуск BDUI-server + API service + DB и проверка ключевых бизнес‑flow end‑to‑end.
- [ ] Проверка кэша `GET /me` в BDUI-server: серия запросов в пределах TTL (default = 120 секунд) не вызывает лишних обращений к API service, по истечении TTL — обновляет user context.

### Нагрузочные/перфоманс

- [ ] Smoke load (k6/gatling): списки `/objects`, `/inspections`, `/defects`, `/expenses`.
- [ ] DB профилирование: медленные запросы, индексы, N+1.

### Security tests

- [ ] SAST (detekt/spotbugs) + секрет‑скан.
- [ ] Dependency scanning (SCA).
- [ ] DAST (минимум: auth/permissions/fuzz на основные эндпоинты).
- [ ] Тесты на горизонтальную эскалацию прав (IDOR): доступ к чужим объектам/расходам/дефектам.

---

## 2) Обязательные сценарии (smoke/regression)

### Auth

- [ ] Register → confirm (OTP) → login → refresh → logout.
- [ ] Refresh через BDUI-server (проксирование `/auth/refresh`): access обновляется, старый access становится невалидным (если используем rotation/TTL).
- [ ] Reset password: request → confirm → login новым паролем.
- [ ] Негатив: неверный OTP, истёкший OTP, превышение попыток, блокировка пользователя.
- [ ] Mock OTP: тестовый способ “достать код” без реальной почты (не должен попадать в prod).

### Пользователь/права

- [ ] `GET /me`, `PATCH /me` (валидация полей/настроек).
- [ ] Настройки sync конфликтов в профиле: сохранить → прочитать → влияние на поведение `/sync/batch`.
- [ ] Матрица ролей на ключевые операции (admin/landlord/inspector/tenant).

### Объекты/арендаторы

- [ ] Создать объект → изменить → архивировать → разархивировать.
- [ ] Создать арендатора → link/unlink к объекту.
- [ ] Поиск/фильтры/сортировка объектов.

### Осмотры

- [ ] Создать осмотр → старт → обновлять чек‑лист → finish → approve/reject.
- [ ] Генерация дефекта из проблемного пункта (если включено).
- [ ] Негатив: редактирование после старта, запрещённые переходы статусов.

### Дефекты

- [ ] Создать дефект → назначить исполнителя → менять статусы → добавить комментарии/вложения.
- [ ] Фильтры: просрочка, приоритет, “назначенные мне”.

### Расходы

- [ ] Создать расход (draft) → submit → approve/reject → проверить статусы/историю.
- [ ] Правило видимости: пользователь не видит чужие расходы (кроме участника подтверждения).

### Показания

- [ ] Добавить прибор → добавить показания → история.
- [ ] Проверки: меньше предыдущего, аномальный скачок.

### Вложения

- [ ] Upload → metadata → download → привязка к сущности → попытка удалить по правилам (и отдельно: storage адаптеры локальный ↔ CDN).
- [ ] (Опционально, будущее) pre‑signed upload flow покрыт отдельными тестами после внедрения (prepare/complete).

### Уведомления/push

- [ ] Регистрация push токена → генерация уведомления на событие → `GET /notifications` → read/read-all.
- [ ] Push provider: FCM (интеграционные тесты через mock/fake).

### Sync/offline

- [ ] `/sync/batch`: пачка операций → повторы (duplicate) → частичный успех.
- [ ] `/sync/since`: получить изменения, применить повторно без дублей.
- [ ] Конфликты: `baseVersion` не совпал → conflict → повторная отправка после разрешения.
- [ ] Авто‑разрешение конфликтов (LWW): после согласия пользователя стратегия применяется автоматически и покрыта интеграционными тестами.
- [ ] Без согласия на auto‑LWW: стратегия `server wins` применяется без диалогов и локальный кэш обновляется серверным состоянием.

### Audit

- [ ] После ключевых операций появляются audit events и доступны по фильтрам/сущностям.

---

## 3) Чек‑лист готовности тестов по эндпоинтам

> Идея: каждый эндпоинт имеет минимум: (1) unit на бизнес‑правила, (2) API test на HTTP слой, (3) RBAC тест.

### Auth (`/auth/*`)

- [ ] Все эндпоинты покрыты API тестами (happy + негатив).
- [ ] Есть тесты на rate limit/lockout (минимум как интеграция).

### `/me`, `/users`

- [ ] Тесты на права (кто может читать/обновлять/админить).
- [ ] Тесты на валидацию обновления профиля/настроек.

### `/ref/*`

- [ ] Snapshot тесты справочников (контракт стабильности).

### `/objects`, `/tenants`

- [ ] Тесты фильтрации/сортировки/пагинации.
- [ ] Тесты на доступ к “чужим” объектам.

### `/inspections`

- [ ] Тесты state machine (запрещённые переходы).
- [ ] Тесты конкуренции (два обновления чек‑листа/статуса).

### `/defects`

- [ ] Тесты на просрочку и фильтры.
- [ ] Тесты на комментарии/вложения.

### `/expenses`

- [ ] Тесты на visibility rule.
- [ ] Тесты сценариев подтверждения (approve/reject/cancel).

### `/meters`

- [ ] Тесты проверок показаний.

### `/attachments`

- [ ] Тесты лимитов (тип/размер), прав доступа, удаления по правилам.

### `/notifications`, `/push/token`

- [ ] Тесты чтения/прочитанности.
- [ ] Интеграция регистрации токена (валидация + idempotency при повторе).

### `/sync/*`

- [ ] Тесты идемпотентности и частичного успеха батча.
- [ ] Тесты конфликта (если поддерживается) и согласованности “since”.

### `/audit/*`

- [ ] Тесты полноты аудита на ключевые операции + фильтры.

---

## 4) CI: минимальный набор прогонов

- [ ] `unit` (быстро, без контейнеров).
- [ ] `integration` (Testcontainers: Postgres + optional MinIO).
- [ ] `contract` (OpenAPI validation / snapshots / consumer contracts).
- [ ] `e2e-smoke` (опционально, но очень желательно перед релизом).
